<!doctype html>
<html lang="en"><head>
<title>Making Python programs fast</title>
<!-- Boilerplate and theme selection {{{ -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">


        <link rel="stylesheet" href="https://unpkg.com/reveal.js@^5//dist/reset.css">
        <link rel="stylesheet" href="https://unpkg.com/reveal.js@^5//dist/reveal.css">
        <!-- The theme for this presentation -->
        <link rel="stylesheet" href="https://unpkg.com/reveal.js@^5//dist/theme/dracula.css" id="theme">
        <!-- The theme for syntax highlighting -->
        <link rel="stylesheet" href="https://unpkg.com/reveal.js@^5//plugin/highlight/monokai.css" id="theme">
	</head>
	<body> <div class="reveal"> <div class="slides">
<!-- }}} -->

<style>
code { overflow: hidden !important; }
</style>

<section id="title">
  <h2>Making Python programs <em>fast</em></h2>
  <p>Kovid Goyal</p>
  <p><small>September 21, 2024 @ PyCon India</small></p>
</section>

<section id="need-for-speed">
    <h3>The <em>need</em> for speed</h3>
    <ul>
        <li class="fragment">Single core performance flatlined</li>
        <li class="fragment">Performance == energy saving == battery life</li>
        <li class="fragment">Users <em>love</em> performant software</li>
        <li class="fragment">I feel the need, the need for <em>speed</em></li>
    </ul>
</section>

<section id="is-it-even-possible">
    <h3>Is it even possible?</h3>
    <ul class="fragment">
        <li>Python is <em>slow</em> (100x slowdown)</li>
        <li>No heroes to save us</li>
        <li class="fragment">Nonetheless, it <strong>is</strong> possible</li>
        <table style="font-size: 0.65em; margin-top:0.5em" class="fragment">
            <tr><td>Terminal</td><td>Language</td><td>MB/s</td></tr>
            <tr><td>Konsole</td><td>C++</td><td>27</td></tr>
            <tr><td>Alacritty</td><td>Rust</td><td>54</td></tr>
            <tr><td>GNOME Terminal</td><td>C++</td><td>62</td></tr>
            <tr class="fragment"><td><strong>kitty<strong></td><td>Python + C</td><td><em>135</em></td></tr>
        </table>
    </ul>
</section>

<section id="base64-baseline">
    <h3>Case study: <em>base64</em></h3>
    <pre style="text-align: center"><code data-trim class="sh">
        head -c 1073741824 < /dev/urandom > /dev/shm/data
        hyperfine 'base64 -w 0 < /dev/shm/data > /dev/null'
    </code></pre>
    Rate: 1.6 <em>GB/s</em>
    <div class="fragment"><pre><code data-trim class="python naive_implementation"></code></pre></div>
    <div class="fragment">Rate: 1.2 <em>MB/s</em> 1000x slower!!</div>
</section>

<section id="fix-naive">
    <h3>Do not be naive</h3>
    <div class="r-stack">
        <div class="fragment fade-out" data-fragment-index="0">
            <pre><code data-trim data-line-numbers='5' class="python naive_implementation"></code></pre>
        </div>
        <div class="fragment" data-fragment-index="0">
            <pre><code data-trim data-line-numbers='3-4' class="python noslice"></code></pre>
        </div>
    </div>
    <div class="fragment">Rate: 6.5 <em>MB/s</em> 5x faster</div>
</section>

<section id="memoryview">
    <h3>Intermezzo: <em>memoryview</em></h3>
    <div><pre><code data-trim class="python memoryview" data-line-numbers='2-3,6,12'></code></pre></div>
    <div class="fragment">
        <div>Rate: 6.0 <em>MB/s</em> same speed</div>
        <div>Binary data â‡’  <em>use memoryview</em></div>
    </div>
</section>


<script>
    const naive_implementation = `
def naive_implementation(inp: bytes) -> bytes:
    i = 0
    while len(inp) > 2:
        triple = (inp[0] << 16) + (inp[1] << 8) + inp[2]
        inp = inp[3:]

        output[i] = base64_chars[(triple >> 18) & 63]
        output[i+1] = base64_chars[(triple >> 12) & 63]
        output[i+2] = base64_chars[(triple >> 6) & 63]
        output[i+3] = base64_chars[triple & 63]
        i += 4
    return bytes(output)
`;

const noslice = `
def noslice(inp: bytes) -> bytes:
    i = 0
    for j in range(0, len(inp), 3):
        triple = (inp[j] << 16) + (inp[j+1] << 8) + inp[j+2]

        output[i] = base64_chars[(triple >> 18) & 63]
        output[i+1] = base64_chars[(triple >> 12) & 63]
        output[i+2] = base64_chars[(triple >> 6) & 63]
        output[i+3] = base64_chars[triple & 63]
        i += 4
    return bytes(output)
`

const memoryview = `
def memview(input_bytes: bytes) -> bytes:
    input_bytes = memoryview(input_bytes)
    o = memoryview(output)
    while len(input_bytes) > 2:
        triple = (input_bytes[0] << 16) + (input_bytes[1] << 8) + input_bytes[2]
        input_bytes = input_bytes[3:]

        o[0] = base64_chars[(triple >> 18) & 63]
        o[1] = base64_chars[(triple >> 12) & 63]
        o[2] = base64_chars[(triple >> 6) & 63]
        o[3] = base64_chars[triple & 63]
        o = o[4:]
    return bytes(output)
`
    function insert_code_block(code, classname) {
        for (const elem of document.getElementsByClassName(classname)) {
            elem.textContent = code;
        }
    }
    insert_code_block(naive_implementation, 'naive_implementation')
    insert_code_block(noslice, 'noslice')
    insert_code_block(memoryview, 'memoryview')
</script>

<!-- plugins and configuration {{{ -->
</div></div>
<script src="https://unpkg.com/reveal.js@^5//dist/reveal.js"></script>

<!-- reveal.js plugins -->
<script src="https://unpkg.com/reveal.js@^5//plugin/notes/notes.js"></script>
<script src="https://unpkg.com/reveal.js@^5//plugin/markdown/markdown.js"></script>
<script src="https://unpkg.com/reveal.js@^5//plugin/highlight/highlight.js"></script>

<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,
        slideNumber: 'c/t',

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
    });
</script> </body> </html>
<!-- }}} --->
